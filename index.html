<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>ç¦å²¡çœŒãƒãƒ©ã‚·é…å¸ƒãƒãƒƒãƒ—</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />

<!-- Leaflet & TopoJSON -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/topojson-client@3"></script>

<!-- ===== æ˜ã‚‹ããƒãƒƒãƒ—ãªãƒ†ãƒ¼ãƒ ===== -->
<style>
  :root{
    --bg:linear-gradient(135deg,#ff9a9e 0%,#fecfef 50%,#fecfef 100%);
    --card:rgba(255,255,255,.95); --accent:#ff6b6b;
    --fg:#2c3e50; --border:rgba(255,107,107,.3);
  }
  html,body{margin:0;height:100%;background:var(--bg);
    font-family:"Comic Sans MS","Hiragino Kaku Gothic ProN","ãƒ¡ã‚¤ãƒªã‚ª",Meiryo,sans-serif;
    color:var(--fg);font-weight:600;}
  #map{height:100%;width:100%}
  .title{position:absolute;top:10px;left:50%;transform:translateX(-50%);
    background:var(--card);padding:14px 24px;border-radius:25px;
    box-shadow:0 4px 15px rgba(255,107,107,.3);border:2px solid var(--border);
    z-index:1000;font-size:1.25rem;font-weight:bold;color:var(--accent);
    text-align:center;backdrop-filter:blur(10px);}
  .leaflet-popup-content{margin:6px 8px;font-size:.9rem;line-height:1.3;}

  /* â–¼ åˆè¨ˆæšæ•°ãƒãƒƒã‚¸ */
  #total-counter{
    position:absolute;bottom:15px;right:15px;
    background:var(--card);color:var(--fg);
    border:2px solid var(--border);border-radius:15px;
    padding:10px 18px;font-size:1rem;font-weight:bold;
    box-shadow:0 3px 10px rgba(255,107,107,.25);
    backdrop-filter:blur(10px);z-index:1000;
  }
</style>
</head>
<body>
  <div class="title">ç¦å²¡çœŒãƒãƒ©ã‚·é…å¸ƒãƒãƒƒãƒ—</div>
  <div id="map"></div>
  <!-- åˆè¨ˆæšæ•°ã‚’è¡¨ç¤º -->
  <div id="total-counter">ğŸ“¦ è¨ˆç®—ä¸­â€¦</div>

<script>
/* ------------------------------------------------------------
   0) Leaflet ãƒ™ãƒ¼ã‚¹ãƒãƒƒãƒ—
------------------------------------------------------------ */
const map=L.map("map",{zoomSnap:0.25,inertia:true}).setView([33.58,130.58],9);
L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
  {attribution:"&copy; OpenStreetMap contributors, &copy; CARTO"}).addTo(map);

/* ------------------------------------------------------------
   1) å¸‚ç”ºæ‘å¢ƒç•Œç·šï¼ˆTopoJSON â†’ GeoJSONï¼‰
------------------------------------------------------------ */
const topoURL="https://geoshape.ex.nii.ac.jp/city/topojson/20230101/40/40_city_dc.l.topojson";
fetch(topoURL).then(r=>r.json()).then(topo=>{
  const key=Object.keys(topo.objects).find(k=>topo.objects[k].type==="GeometryCollection");
  const geo=topojson.feature(topo, topo.objects[key]);

  const layer=L.geoJSON(geo,{
    style:()=>({weight:2,color:"var(--accent)",fillOpacity:.15,fillColor:"#ffffff"}),
    onEachFeature:(f,l)=>{
      const n=f.properties.name||f.properties.N03_004||f.properties.N03_003;
      l.bindTooltip(n,{sticky:true});
      l.on({
        mouseover:e=>e.target.setStyle({fillOpacity:.35}),
        mouseout :e=>e.target.setStyle({fillOpacity:.15})
      });
    }
  }).addTo(map);

  const b=layer.getBounds();
  map.fitBounds(b); map.setMaxBounds(b.pad(0.4));

  plotPoints();               // å¢ƒç•Œæç”»å¾Œã«ãƒãƒ¼ã‚«ãƒ¼é…ç½®
});

/* ------------------------------------------------------------
   2) é…å¸ƒãƒã‚¤ãƒ³ãƒˆä¸€è¦§ï¼ˆã™ã¹ã¦æšæ•°å…¥ã‚Šï¼‰
------------------------------------------------------------ */
const pointsList = [
  /* â”€â”€ åšå¤šåŒº â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  { place:"åšå¤šåŒº ç©ºæ¸¯å‰ï½¥é’æœ¨ï½¥æ±å¹³å°¾",   count:2000, lat:33.595024, lng:130.455876 },
  { place:"åšå¤šåŒº ã¿ã©ã‚ŠãŒä¸˜ï½¥é’è‘‰",      count:1000, lat:33.646233, lng:130.475250 },

  /* â”€â”€ ä¸­å¤®åŒº â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  { place:"ä¸­å¤®åŒº å‹æ³‰ï½¥æ¢…å…‰åœ’",          count:1000, lat:33.575189, lng:130.376544 },
  { place:"ä¸­å¤®åŒº è’æˆ¸",                count:1000, lat:33.590379, lng:130.377177 },
  { place:"ä¸­å¤®åŒº è–¬é™¢3ï½¥4ä¸ç›®",          count: 900, lat:33.578236, lng:130.400067 },
  { place:"ä¸­å¤®åŒº è­¦å›º2ä¸ç›®",            count: 300, lat:33.583322, lng:130.393252 },

  /* â”€â”€ å—åŒº â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  { place:"å—åŒº æ¡§åŸå›£åœ°",              count: 300, lat:33.534961, lng:130.399262 },
  { place:"å—åŒº é•·ä½å›£åœ°ã¨å‘¨è¾º",         count:1000, lat:33.550799, lng:130.394959 },
  { place:"å—åŒº æŸåŸ6ä¸ç›®",             count: 700, lat:33.525753, lng:130.391919 },
  { place:"å—åŒº æŸåŸ3ä¸ç›®",             count: 100, lat:33.525392, lng:130.403302 },
  { place:"å—åŒº å„æ‰€",                  count:2000, lat:33.561589, lng:130.426554 },
  { place:"å—åŒº é«˜å®®ã€œé‡é–“",            count: 200, lat:33.563794, lng:130.416112 },
  { place:"å—åŒº å¤§æ©‹1ä¸ç›®",             count: 400, lat:33.559078, lng:130.426091 },

  /* â”€â”€ åŸå—åŒºãƒ»æ—©è‰¯åŒº â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  { place:"åŸå—åŒº èŒ¶å±±4ä¸ç›®",           count: 200, lat:33.561478, lng:130.364663 },
  { place:"åŸå—åŒº èŒ¶å±±6ä¸ç›®",           count: 200, lat:33.568966, lng:130.363160 },
  { place:"åŸå—åŒº é‡‘å±±å›£åœ°",            count: 250, lat:33.557871, lng:130.367776 },
  { place:"åŸå—åŒº è’æ±Ÿå›£åœ°",            count: 350, lat:33.572843, lng:130.359941 },
  { place:"åŸå—åŒº æ¢…æ—",                count: 200, lat:33.545831, lng:130.354939 },
  { place:"æ—©è‰¯åŒº åŸå›£åœ°",              count: 500, lat:33.570133, lng:130.340509 },

  /* â”€â”€ å¤ªå®°åºœå¸‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  { place:"å¤ªå®°åºœå¸‚",                   count:1000, lat:33.512860, lng:130.523750 },

  /* â”€â”€ ä¹…ç•™ç±³å¸‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  { place:"ä¹…ç•™ç±³å¸‚ åŸå—ç”º",            count: 100, lat:33.320600, lng:130.509900 },
  { place:"ä¹…ç•™ç±³å¸‚ æ±åˆå·",            count: 420, lat:33.326008, lng:130.550114 },
  { place:"ä¹…ç•™ç±³å¸‚ è¥¿ç”º",             count: 420, lat:33.295798, lng:130.518104 },
  { place:"ä¹…ç•™ç±³å¸‚ å—ç”º",             count: 420, lat:33.291002, lng:130.526836 },
  { place:"ä¹…ç•™ç±³å¸‚ æ´¥ç¦",             count: 420, lat:33.291578, lng:130.497258 },
  { place:"ä¹…ç•™ç±³å¸‚ å¤§å–„å¯º",           count: 420, lat:33.268768, lng:130.481324 },
  { place:"ä¹…ç•™ç±³å¸‚ å®‰æ­¦",             count: 420, lat:33.286031, lng:130.488645 },
  { place:"ä¹…ç•™ç±³å¸‚ é’å³°",             count: 420, lat:33.285175, lng:130.557931 },
  { place:"ä¹…ç•™ç±³å¸‚ å¤§çŸ³ç”º",           count: 420, lat:33.315888, lng:130.497743 },

  /* â”€â”€ å—éƒ¨ï¼“å¸‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  { place:"ã¿ã‚„ã¾å¸‚",                  count: 200, lat:33.150338, lng:130.468887 },
  { place:"æŸ³å·å¸‚",                    count: 420, lat:33.162900, lng:130.405700 },
  { place:"å¤§ç‰Ÿç”°å¸‚",                count:4600, lat:33.030200, lng:130.445900 },

  /* â”€â”€ ç›´éãƒ»åŒ—ä¹å· â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  { place:"ç›´éåœ°åŸŸ",                count:5000, lat:33.744100, lng:130.729700 },
  { place:"åŒ—ä¹å·å¸‚",              count:10000, lat:33.883000, lng:130.875300 },

  /* â”€â”€ å„é¸æŒ™åŒºé€£åˆãƒ»å¸‚æ°‘ã®ä¼š â”€â”€â”€â”€â”€â”€â”€ */
  { place:"3åŒºå¸‚æ°‘é€£åˆ",           count: 5000, lat:33.553890, lng:130.197780 },
  { place:"4åŒºå¸‚æ°‘é€£åˆ",           count:10000, lat:33.800000, lng:130.533330 },
  { place:"5åŒºã®ä¼š",              count: 3000, lat:33.487500, lng:130.525830 },
  { place:"9æ¡ã®ä¼š(6åŒº)",         count:  500, lat:33.316700, lng:130.516700 }
];

/* ------------------------------------------------------------
   3) æ‰‹å‹•ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”¨ï¼ˆä»Šå›ã¯ç©ºï¼‰
------------------------------------------------------------ */
const manualCoords={};

/* ------------------------------------------------------------
   4) ã‚¸ã‚ªã‚³ãƒ¼ãƒ€é–¢æ•°ï¼ˆåº§æ¨™ç©ºæ¬„ã®åœ°ç‚¹ã ã‘åˆ©ç”¨ï¼‰
------------------------------------------------------------ */
async function geocode(addr){
  const key=`geo::${addr}`;
  const cached=localStorage.getItem(key);
  if(cached) return JSON.parse(cached);
  if(manualCoords[addr]) return manualCoords[addr];

  const url=`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent("ç¦å²¡çœŒ "+addr)}`;
  const res=await fetch(url,{headers:{'Accept-Language':'ja'}});
  const js=await res.json();
  if(js[0]){
    const ll=[+js[0].lat,+js[0].lon];
    localStorage.setItem(key,JSON.stringify(ll));
    await new Promise(r=>setTimeout(r,1000)); // rate-limit
    return ll;
  }
  console.warn("Geocode å¤±æ•—:",addr);
  return null;
}

/* ------------------------------------------------------------
   5) ãƒãƒ¼ã‚«ãƒ¼ã‚’æç”» & åˆè¨ˆæšæ•°ã‚’è¡¨ç¤º
------------------------------------------------------------ */
async function plotPoints(){
  let total=0;

  for(const p of pointsList){
    const ll=(typeof p.lat==="number"&&typeof p.lng==="number")
             ? [p.lat,p.lng] : await geocode(p.place);
    if(!ll) continue;

    total += p.count || 0;

    const marker=L.circleMarker(ll,{
      radius:8,weight:2,
      color:"#ff4757",fillColor:"#ff4757",fillOpacity:0.8
    }).addTo(map);

    const popupHTML=`<strong>${p.place}</strong><br>é…å¸ƒæšæ•°ï¼š${p.count.toLocaleString()} æš`;
    marker.bindPopup(popupHTML,{closeButton:false});
    marker.on("mouseover",()=>marker.openPopup());
    marker.on("mouseout", ()=>marker.closePopup());
  }

  document.getElementById("total-counter")
          .textContent=`ğŸ“¦ é…å¸ƒæšæ•°ï¼š${total.toLocaleString()} æš`;
}
</script>
</body>
</html>
