<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>福岡県チラシ配布マップ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Leaflet & TopoJSON -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/topojson-client@3"></script>

  <!-- ===== 明るくポップなテーマ ===== -->
  <style>
    :root{
      --bg:linear-gradient(135deg,#ff9a9e 0%,#fecfef 50%,#fecfef 100%);
      --card:rgba(255,255,255,.95); --accent:#ff6b6b;
      --fg:#2c3e50; --border:rgba(255,107,107,.3);
    }
    html,body{margin:0;height:100%;background:var(--bg);
      font-family:"Comic Sans MS","Hiragino Kaku Gothic ProN","メイリオ",Meiryo,sans-serif;
      color:var(--fg);font-weight:600;}
    #map{height:100%;width:100%}
    .title{position:absolute;top:10px;left:50%;transform:translateX(-50%);
      background:var(--card);padding:14px 24px;border-radius:25px;
      box-shadow:0 4px 15px rgba(255,107,107,.3);border:2px solid var(--border);
      z-index:1000;font-size:1.25rem;font-weight:bold;color:var(--accent);
      text-align:center;backdrop-filter:blur(10px);}
    .leaflet-popup-content{margin:6px 8px;font-size:.9rem;line-height:1.3;}
  </style>
</head>
<body>
  <div class="title">福岡県チラシ配布マップ</div>
  <div id="map"></div>

<script>
/* ------------------------------------------------------------
   0) Leaflet ベースマップ
------------------------------------------------------------ */
const map=L.map("map",{zoomSnap:0.25,inertia:true}).setView([33.58,130.58],9);
L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
  {attribution:"&copy; OpenStreetMap contributors, &copy; CARTO"}).addTo(map);

/* ------------------------------------------------------------
   1) 市町村境界線（TopoJSON → GeoJSON）
------------------------------------------------------------ */
const topoURL="https://geoshape.ex.nii.ac.jp/city/topojson/20230101/40/40_city_dc.l.topojson";
fetch(topoURL).then(r=>r.json()).then(topo=>{
  const key=Object.keys(topo.objects).find(k=>topo.objects[k].type==="GeometryCollection");
  const geo=topojson.feature(topo, topo.objects[key]);

  const layer=L.geoJSON(geo,{
    style:()=>({weight:2,color:"var(--accent)",fillOpacity:.15,fillColor:"#ffffff"}),
    onEachFeature:(f,l)=>{
      const n=f.properties.name||f.properties.N03_004||f.properties.N03_003;
      l.bindTooltip(n,{sticky:true});
      l.on({
        mouseover:e=>e.target.setStyle({fillOpacity:.35}),
        mouseout :e=>e.target.setStyle({fillOpacity:.15})
      });
    }
  }).addTo(map);

  const b=layer.getBounds();
  map.fitBounds(b); map.setMaxBounds(b.pad(0.4));

  plotPoints();  // 境界描画後にマーカー配置
});

/* ===== チラシ配布ポイント一覧 ===== */
const pointsList = [
  /* ── 博多区 ─────────────────── */
  { place:"博多区 空港前･青木･東平尾",     count:2000, lat:33.595024, lng:130.455876 }, //:contentReference[oaicite:0]{index=0}
  { place:"博多区 みどりが丘･青葉",        count:1000, lat:33.646233, lng:130.475250 }, //:contentReference[oaicite:1]{index=1}
  { place:"博多区 みどりが丘･青葉",                      lat:33.645880, lng:130.466559 }, // 青葉エリア補助点 :contentReference[oaicite:2]{index=2}

  /* ── 中央区 ─────────────────── */
  { place:"中央区 友泉･梅光園",            count:1000, lat:33.575189, lng:130.376544 }, //:contentReference[oaicite:3]{index=3}
  { place:"中央区 荒戸",                  count:1000, lat:33.590379, lng:130.377177 }, //:contentReference[oaicite:4]{index=4}
  { place:"中央区 薬院3･4丁目",            count: 900, lat:33.578236, lng:130.400067 }, //:contentReference[oaicite:5]{index=5}
  { place:"中央区 警固2丁目",              count: 300, lat:33.583322, lng:130.393252 }, //:contentReference[oaicite:6]{index=6}

  /* ── 南区 ─────────────────── */
  { place:"南区 桧原団地",                count: 300, lat:33.534961, lng:130.399262 }, //:contentReference[oaicite:7]{index=7}
  { place:"南区 長住団地と周辺",           count:1000, lat:33.550799, lng:130.394959 }, //:contentReference[oaicite:8]{index=8}
  { place:"南区 柏原6丁目",               count: 700, lat:33.525753, lng:130.391919 }, //:contentReference[oaicite:9]{index=9}
  { place:"南区 柏原3丁目",               count: 100, lat:33.525392, lng:130.403302 }, //:contentReference[oaicite:10]{index=10}
  { place:"南区 各所",                    count:2000, lat:33.561589, lng:130.426554 }, // ward centre :contentReference[oaicite:11]{index=11}
  { place:"南区 高宮〜野間",              count: 200, lat:33.563794, lng:130.416112 }, //:contentReference[oaicite:12]{index=12}
  { place:"南区 大橋1丁目",               count: 400, lat:33.559078, lng:130.426091 }, //:contentReference[oaicite:13]{index=13}

  /* ── 城南区・早良区 ────────────── */
  { place:"城南区 茶山4丁目",             count: 200, lat:33.561478, lng:130.364663 }, //:contentReference[oaicite:14]{index=14}
  { place:"城南区 茶山6丁目",             count: 200, lat:33.568966, lng:130.363160 }, //:contentReference[oaicite:15]{index=15}
  { place:"城南区 金山団地",              count: 250, lat:33.557871, lng:130.367776 }, //:contentReference[oaicite:16]{index=16}
  { place:"城南区 荒江団地",              count: 350, lat:33.572843, lng:130.359941 }, //:contentReference[oaicite:17]{index=17}
  { place:"城南区 梅林",                  count: 200, lat:33.545831, lng:130.354939 }, //:contentReference[oaicite:18]{index=18}
  { place:"早良区 原団地",                count: 500, lat:33.570133, lng:130.340509 }, //:contentReference[oaicite:19]{index=19}

  /* ── 太宰府市 ───────────────── */
  { place:"太宰府市",                     count:1000, lat:33.51286, lng:130.52375 },  // 市役所付近 :contentReference[oaicite:20]{index=20}

  /* ── 久留米市 ───────────────── */
  { place:"久留米市 城南町",              count: 100, lat:33.320600, lng:130.509900 }, // 先ほどご提供
  { place:"久留米市 東合川",                          lat:33.326008, lng:130.550114 }, //:contentReference[oaicite:21]{index=21}
  { place:"久留米市 西町",                            lat:33.295798, lng:130.518104 }, //:contentReference[oaicite:22]{index=22}
  { place:"久留米市 南町",                            lat:33.291002, lng:130.526836 }, //:contentReference[oaicite:23]{index=23}
  { place:"久留米市 津福",                            lat:33.291578, lng:130.497258 }, //:contentReference[oaicite:24]{index=24}
  { place:"久留米市 大善寺",                          lat:33.268768, lng:130.481324 }, //:contentReference[oaicite:25]{index=25}
  { place:"久留米市 安武",                            lat:33.286031, lng:130.488645 }, //:contentReference[oaicite:26]{index=26}
  { place:"久留米市 青峰",                            lat:33.285175, lng:130.557931 }, //:contentReference[oaicite:27]{index=27}
  { place:"久留米市 大石町",                          lat:33.315888, lng:130.497743 }, //:contentReference[oaicite:28]{index=28}

  /* ── 南部３市 ───────────────── */
  { place:"みやま市",                                lat:33.150338, lng:130.468887 }, //:contentReference[oaicite:29]{index=29}
  { place:"柳川市",                                  lat:33.162900, lng:130.405700 }, //:contentReference[oaicite:30]{index=30}
  { place:"大牟田市",                                lat:33.030200, lng:130.445900 }  //:contentReference[oaicite:31]{index=31}
];

/* ------------------------------------------------------------
   3) 手動ジオコーディング用（今回は空だが将来追加可）
------------------------------------------------------------ */
const manualCoords={};

/* ------------------------------------------------------------
   4) ジオコーダ関数（座標空欄の地点だけ利用）
------------------------------------------------------------ */
async function geocode(addr){
  const key=`geo::${addr}`;
  const cached=localStorage.getItem(key);
  if(cached) return JSON.parse(cached);
  if(manualCoords[addr]) return manualCoords[addr];

  const url=`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent("福岡県 "+addr)}`;
  const res=await fetch(url,{headers:{'Accept-Language':'ja'}});
  const js=await res.json();
  if(js[0]){
    const ll=[+js[0].lat,+js[0].lon];
    localStorage.setItem(key,JSON.stringify(ll));
    await new Promise(r=>setTimeout(r,1000)); // rate-limit
    return ll;
  }
  console.warn("Geocode 失敗:",addr);
  return null;
}

/* ------------------------------------------------------------
   5) マーカーを描画（全て同じデザイン）
------------------------------------------------------------ */
async function plotPoints(){
  for(const p of pointsList){
    let ll = (typeof p.lat==="number" && typeof p.lng==="number")
             ? [p.lat,p.lng]
             : await geocode(p.place);
    if(!ll) continue;

    const marker=L.circleMarker(ll,{
      radius:8, weight:2,
      color:"#ff4757", fillColor:"#ff4757", fillOpacity:0.8
    }).addTo(map);

    marker.bindPopup(
      `<strong>${p.place}</strong><br>配布枚数：${p.count.toLocaleString()} 枚`,
      {closeButton:false}
    );
    marker.on("mouseover",()=>marker.openPopup());
    marker.on("mouseout", ()=>marker.closePopup());
  }
}
</script>
</body>
</html>
