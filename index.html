<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>ã€Œå®‰ä¾¡å®‰å¿ƒã§é£Ÿã¹ãŸã„ã‹ã‚‰æ”¿æ¨©ã‚‚ã„ãŸã ãã¾ã™ã€ãƒãƒ©ã‚·é…å¸ƒçŠ¶æ³</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    /* ===== æ˜ã‚‹ããƒãƒƒãƒ—ãªãƒ†ãƒ¼ãƒ ===== */
    :root {
      --bg: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
      --card: rgba(255, 255, 255, 0.95);
      --accent: #ff6b6b;
      --fg: #2c3e50;
      --border: rgba(255, 107, 107, 0.3);
    }

    html,body {
      margin: 0;
      height: 100%;
      background: var(--bg);
      font-family: "Comic Sans MS", "Hiragino Kaku Gothic ProN", "ãƒ¡ã‚¤ãƒªã‚ª", Meiryo, sans-serif;
      color: var(--fg);
      font-weight: 600;
    }
    
    #map { 
      height: 100%; 
      width: 100%; 
      border-radius: 0;
    }

    /* ã‚¿ã‚¤ãƒˆãƒ« */
    .title {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--card);
      padding: 15px 25px;
      border-radius: 25px;
      box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
      border: 2px solid var(--border);
      z-index: 1000;
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--accent);
      text-align: center;
      backdrop-filter: blur(10px);
    }

    /* ãƒãƒªã‚´ãƒ³ã®ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ãƒ‹ãƒ¡ */
    .leaflet-interactive { 
      transition: fill 0.3s ease, stroke 0.3s ease, fill-opacity 0.3s ease; 
    }

    /* å‡¡ä¾‹ã‚«ãƒ¼ãƒ‰ */
    .legend {
      background: var(--card);
      line-height: 1.6em;
      padding: 15px 20px;
      font-size: 1rem;
      border-radius: 20px;
      box-shadow: 0 4px 20px rgba(255, 107, 107, 0.25);
      border: 2px solid var(--border);
      backdrop-filter: blur(10px);
    }
    .legend i {
      width: 20px; 
      height: 20px; 
      float: left; 
      margin-right: 10px;
      border-radius: 50%;
      border: 2px solid rgba(255, 107, 107, 0.4);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    /* CSV ãƒœã‚¿ãƒ³ */
    .ui-btn {
      background: var(--card);
      color: var(--fg);
      border: 2px solid var(--border);
      border-radius: 15px;
      padding: 10px 15px;
      font-size: 1rem;
      cursor: pointer;
      backdrop-filter: blur(10px);
      font-weight: bold;
      box-shadow: 0 3px 10px rgba(255, 107, 107, 0.2);
      transition: all 0.3s ease;
    }
    
    .ui-btn:hover {
      background: var(--accent);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
    }
    
    .ui-container { 
      position: absolute; 
      top: 10px; 
      left: 10px; 
      z-index: 1000; 
      display: flex; 
      align-items: center; 
    }

    /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .leaflet-tooltip {
      background: var(--card) !important;
      border: 2px solid var(--border) !important;
      border-radius: 10px !important;
      color: var(--fg) !important;
      font-weight: bold !important;
      box-shadow: 0 3px 10px rgba(255, 107, 107, 0.3) !important;
    }
  </style>
</head>
<body>
  <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
  <div class="title">
    ã€Œå®‰ä¾¡å®‰å¿ƒã§é£Ÿã¹ãŸã„ã‹ã‚‰æ”¿æ¨©ã‚‚ã„ãŸã ãã¾ã™ã€<br>ãƒãƒ©ã‚·é…å¸ƒçŠ¶æ³
  </div>

  <!-- UI ãƒ‘ãƒãƒ«ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºï¼‰ -->
  <div class="ui-container">
    <div class="ui-btn" style="background: rgba(255, 107, 107, 0.1); cursor: default;">
      ğŸ“Š é…å¸ƒãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...
    </div>
  </div>

  <div id="map"></div>

  <!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/d3@7"></script>
  <script src="https://unpkg.com/topojson-client@3"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    /** =============================================
     *  Leaflet ãƒãƒƒãƒ—åˆæœŸåŒ–
     * =========================================== */
    const lightLayer = L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
      attribution: "&copy; OpenStreetMap contributors, &copy; CARTO",
    });

    const map = L.map("map", {
      zoomSnap: 0.25,
      inertia: true,
      zoomControl: false,
      layers: [lightLayer],
    }).setView([33.58, 130.58], 8.5);
    
    L.control.zoom({ position: "bottomleft" }).addTo(map);

    /** TopoJSON ï¼ˆç¦å²¡ã®ã¿ï¼‰ */
    const topoUrl = "https://geoshape.ex.nii.ac.jp/city/topojson/20230101/40/40_city_dc.l.topojson";
    let geoLayer = null;

    fetch(topoUrl)
      .then(r => r.ok ? r.json() : Promise.reject(r.statusText))
      .then(topology => {
        const objKey = Object.keys(topology.objects).find(k => topology.objects[k].type === "GeometryCollection");
        const geo = topojson.feature(topology, topology.objects[objKey]);

        geoLayer = L.geoJSON(geo, {
          style: baseStyle,
          onEachFeature: onEachDistrict,
        }).addTo(map);

        const bounds = geoLayer.getBounds();
        map.fitBounds(bounds);
        map.setMaxBounds(bounds.pad(0.4));

        // é…å¸ƒãƒ‡ãƒ¼ã‚¿è‡ªå‹•èª­ã¿è¾¼ã¿ã‚’å®Ÿè¡Œ
        loadDistributionData();
        
        if (pendingCsvData) applyCSV(pendingCsvData);
      })
      .catch(e => console.error("TopoJSON load error", e));

    /** åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«é–¢æ•° */
    function baseStyle() {
      return {
        weight: 2,
        color: "#ff6b6b",
        fillOpacity: 0.7,
        fillColor: "#f8f9fa", // CSV èª­è¾¼å‰ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆè–„ã„ã‚°ãƒ¬ãƒ¼ï¼‰
      };
    }

    /** å„ãƒãƒªã‚´ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š */
    function onEachDistrict(feature, layer) {
      const label = feature.properties.name || feature.properties.N03_004 || feature.properties.N03_003;
      layer.bindTooltip(label, { 
        sticky: true, 
        direction: "auto",
        className: "custom-tooltip"
      });

      layer.on({
        mouseover: (e) => {
          const t = e.target;
          t.setStyle({
            weight: 4,
            color: "#ff4757",
            fillOpacity: 0.9,
            fillColor: t.myFillColor || t.options.fillColor,
          });
          if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) t.bringToFront();
        },
        mouseout: (e) => {
          const t = e.target;
          t.setStyle({
            weight: 2,
            color: "#ff6b6b",
            fillOpacity: 0.7,
            fillColor: t.myFillColor || t.options.fillColor,
          });
        },
      });
    }

    /** åŸ‹ã‚è¾¼ã¿CSVãƒ‡ãƒ¼ã‚¿ */
    const embeddedCSVData = [
      { district: "ç¦å²¡å¸‚", distributed: true },
      { district: "åŒ—ä¹å·å¸‚", distributed: false },
      { district: "ä¹…ç•™ç±³å¸‚", distributed: false },
      { district: "ç›´æ–¹å¸‚", distributed: false },
      { district: "é£¯å¡šå¸‚", distributed: false },
      { district: "ç”°å·å¸‚", distributed: false },
      { district: "æŸ³å·å¸‚", distributed: false },
      { district: "å…«å¥³å¸‚", distributed: false },
      { district: "ç­‘å¾Œå¸‚", distributed: false },
      { district: "å¤§å·å¸‚", distributed: false },
      { district: "è¡Œæ©‹å¸‚", distributed: false },
      { district: "è±Šå‰å¸‚", distributed: false },
      { district: "ä¸­é–“å¸‚", distributed: false },
      { district: "å°éƒ¡å¸‚", distributed: false },
      { district: "ç­‘ç´«é‡å¸‚", distributed: false },
      { district: "æ˜¥æ—¥å¸‚", distributed: false },
      { district: "å¤§é‡åŸå¸‚", distributed: false },
      { district: "å®—åƒå¸‚", distributed: false },
      { district: "å¤ªå®°åºœå¸‚", distributed: false },
      { district: "å¤è³€å¸‚", distributed: false },
      { district: "ç¦æ´¥å¸‚", distributed: false },
      { district: "ã†ãã¯å¸‚", distributed: false },
      { district: "å®®è‹¥å¸‚", distributed: false },
      { district: "å˜‰éº»å¸‚", distributed: false },
      { district: "æœå€‰å¸‚", distributed: false },
      { district: "ã¿ã‚„ã¾å¸‚", distributed: false },
      { district: "ç³¸å³¶å¸‚", distributed: false },
      { district: "é‚£ç‚å·å¸‚", distributed: false },
      { district: "å®‡ç¾ç”º", distributed: false },
      { district: "ç¯ æ —ç”º", distributed: false },
      { district: "å¿—å…ç”º", distributed: false },
      { district: "é ˆæµç”º", distributed: false },
      { district: "æ–°å®®ç”º", distributed: false },
      { district: "ä¹…å±±ç”º", distributed: false },
      { district: "ç²•å±‹ç”º", distributed: false },
      { district: "èŠ¦å±‹ç”º", distributed: false },
      { district: "æ°´å·»ç”º", distributed: false },
      { district: "å²¡å£ç”º", distributed: false },
      { district: "é è³€ç”º", distributed: false },
      { district: "å°ç«¹ç”º", distributed: false },
      { district: "éæ‰‹ç”º", distributed: false },
      { district: "æ¡‚å·ç”º", distributed: false },
      { district: "ç­‘å‰ç”º", distributed: false },
      { district: "æ±å³°æ‘", distributed: false },
      { district: "å¤§åˆ€æ´—ç”º", distributed: false },
      { district: "å¤§æœ¨ç”º", distributed: false },
      { district: "åºƒå·ç”º", distributed: false },
      { district: "é¦™æ˜¥ç”º", distributed: false },
      { district: "æ·»ç”°ç”º", distributed: false },
      { district: "ç³¸ç”°ç”º", distributed: false },
      { district: "å·å´ç”º", distributed: false },
      { district: "å¤§ä»»ç”º", distributed: false },
      { district: "èµ¤æ‘", distributed: false },
      { district: "ç¦æ™ºç”º", distributed: false },
      { district: "è‹…ç”°ç”º", distributed: false },
      { district: "ã¿ã‚„ã“ç”º", distributed: false },
      { district: "å‰å¯Œç”º", distributed: false },
      { district: "ä¸Šæ¯›ç”º", distributed: false },
      { district: "ç¯‰ä¸Šç”º", distributed: false },
      { district: "å¤§ç‰Ÿç”°å¸‚", distributed: false }
    ];

    /** ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ */
    function loadDistributionData() {
      try {
        pendingCsvData = embeddedCSVData;
        applyCSV(pendingCsvData);
        
        // èª­ã¿è¾¼ã¿å®Œäº†ã®è¡¨ç¤ºæ›´æ–°
        const statusElement = document.querySelector('.ui-container .ui-btn');
        if (statusElement) {
          statusElement.innerHTML = 'âœ… é…å¸ƒãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†';
          statusElement.style.background = 'rgba(76, 175, 80, 0.2)';
        }
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        // ã‚¨ãƒ©ãƒ¼æ™‚ã®è¡¨ç¤ºæ›´æ–°
        const statusElement = document.querySelector('.ui-container .ui-btn');
        if (statusElement) {
          statusElement.innerHTML = 'âŒ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼';
          statusElement.style.background = 'rgba(244, 67, 54, 0.2)';
        }
      }
    }

    /** CSV å–ã‚Šè¾¼ã¿ï¼ˆæ‰‹å‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ãƒ»äºˆå‚™ï¼‰ */
    let pendingCsvData = null;

    /** CSV â†’ ãƒãƒƒãƒ—å¡—ã‚Š (Boolå€¤å¯¾å¿œ) */
    function applyCSV(csvData) {
      if (!geoLayer) return;
      
      const lookup = {};
      csvData.forEach(r => { 
        if (r.district) {
          const district = r.district.trim();
          // Boolå€¤ã®åˆ¤å®šï¼ˆtrue, True, 1, "true", "True"ãªã©ï¼‰
          const isDistributed = r.distributed === true || 
                               r.distributed === 1 || 
                               String(r.distributed).toLowerCase() === "true";
          lookup[district] = isDistributed;
        }
      });

      geoLayer.eachLayer(l => {
        const props = l.feature.properties;
        const name = props.name || props.N03_004 || props.N03_003;
        const isDistributed = lookup[name];
        
        if (isDistributed !== undefined) {
          if (isDistributed) {
            // é…å¸ƒæ¸ˆã¿ = èµ¤è‰²
            const color = "#ff4757";
            l.setStyle({ fillColor: color });
            l.myFillColor = color;
            l.setTooltipContent(`${name}: <strong>âœ… é…å¸ƒæ¸ˆã¿</strong>`);
          } else {
            // æœªé…å¸ƒ = è–„ã„é’è‰²
            const color = "#a4b0be";
            l.setStyle({ fillColor: color });
            l.myFillColor = color;
            l.setTooltipContent(`${name}: <strong>âŒ æœªé…å¸ƒ</strong>`);
          }
        } else {
          // ãƒ‡ãƒ¼ã‚¿ãªã— = ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè‰²
          l.setStyle({ fillColor: "#f8f9fa" });
          l.myFillColor = "#f8f9fa";
          l.setTooltipContent(`${name}: ãƒ‡ãƒ¼ã‚¿ãªã—`);
        }
      });
    }

    /** å‡¡ä¾‹ */
    const legend = L.control({ position: "bottomright" });
    legend.onAdd = () => {
      const div = L.DomUtil.create("div", "legend");
      div.id = "legendBox";
      renderLegend(div);
      return div;
    };
    legend.addTo(map);

    function renderLegend(div) {
      div.innerHTML = `
        <strong>ğŸ—ºï¸ é…å¸ƒçŠ¶æ³</strong><br>
        <i style="background:#ff4757"></i> âœ… é…å¸ƒæ¸ˆã¿<br>
        <i style="background:#a4b0be"></i> âŒ æœªé…å¸ƒ<br>
        <i style="background:#f8f9fa"></i> ğŸ“‹ ãƒ‡ãƒ¼ã‚¿ãªã—<br>
      `;
    }
  </script>
</body>
</html>